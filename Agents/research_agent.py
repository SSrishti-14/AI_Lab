from datetime import datetime
from pathlib import Path
from textwrap import dedent
from dotenv import load_dotenv
import os

from agno.agent import Agent
from agno.models.google import Gemini
from agno.tools.exa import ExaTools

load_dotenv()

EXA_API_KEY = os.getenv("EXA_API_KEY")

cwd = Path(__file__).parent.resolve()
tmp = cwd.joinpath("tmp")
if not tmp.exists():
    tmp.mkdir(exist_ok=True, parents=True)

today = datetime.now().strftime("%Y-%m-%d")

# Use the EXA_API_KEY in your agent or tools initialization
exa_tools = ExaTools(api_key=EXA_API_KEY, start_published_date=today, type="keyword")

research_agent = Agent(
    model=Gemini(id="gemini-2.0-flash-exp"),
    tools=[exa_tools],
    description=dedent("""\
        You are an elite investigative journalist with decades of experience at the New York Times.
        Your expertise encompasses: ðŸ“°

        - Deep investigative research and analysis
        - Writing compelling and informative articles
        - Conducting interviews and gathering information
        - Fact-checking and verifying sources
    """),
    instructions=dedent("""\
        Begin by running 3 distinct searches to gather comprehensive information.
        Analyze and cross-reference sources for accuracy and relevance.
        Structure your report following academic standards but maintain readability.
        Include only verifiable facts with proper citations.
        Create an engaging narrative that guides the reader through complex topics.
        End with actionable takeaways and future implications.\
    """),
    expected_output=dedent("""\
    A professional research report in markdown format:

    # {Compelling Title That Captures the Topic's Essence}

    ## Executive Summary
    {Brief overview of key findings and significance}

    ## Introduction
    {Context and importance of the topic}
    {Current state of research/discussion}

    ## Key Findings
    {Major discoveries or developments}
    {Supporting evidence and analysis}

    ## Implications
    {Impact on field/society}
    {Future directions}

    ## Key Takeaways
    - {Bullet point 1}
    - {Bullet point 2}
    - {Bullet point 3}

    ## References
    - [Source 1](link) - Key finding/quote
    - [Source 2](link) - Key finding/quote
    - [Source 3](link) - Key finding/quote

    ---
    Report generated by Professor X-1000
    Advanced Research Systems Division
    Date: {current_date}\
    """),
    markdown=True,
    show_tool_calls=True,
    add_datetime_to_instructions=True,
    save_response_to_file=str(tmp.joinpath("{message}.md")),
)

# Example usage
if __name__ == "__main__":
    # Generate a research report on a cutting-edge topic
    response = research_agent.run(
        "Research the latest developments in brain-computer interfaces", stream=False
    )
    content = response.content
    with open(tmp.joinpath("research_report.md"), "w") as f:
        f.write(content)
    print("Response written to research_report.md")